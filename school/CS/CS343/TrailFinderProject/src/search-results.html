<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Search Results - Trail Finder</title>
    <link rel="icon" href="https://fav.farm/mountain">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme.css">
</head>

<body>
    <header class="bg-success">
        <h1>Trail Finder</h1>
    </header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">Navigation</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02"
                aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="search.html">Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="near-me.html">Near Me</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user-details.html">User Details</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="report.html">Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documentation.html">Documentation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                </ul>
                <form class="d-flex" role="search" data-bs-theme="light" id="navbarSearchForm">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" id="navbarSearchInput" name="q">
                    <button class="btn btn-light" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
    <main class="container mt-4">
        <h1 class="mb-4">Search Results</h1>
        
        <div class="mb-4">
            <p class="lead">Searching for: <strong id="searchQuery"></strong></p>
        </div>

        <div id="searchResults"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="navbar-search.js"></script>
    <script src="theme.js"></script>
    <script>
        // Get search query from URL
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q') || '';
        
        // Display search query
        document.getElementById('searchQuery').textContent = searchQuery || '(empty)';

        // Pages to search (exclude search-results to avoid recursion)
        const pagesToSearch = [
            { url: 'index.html', title: 'Home' },
            { url: 'search.html', title: 'Search Trails' },
            { url: 'near-me.html', title: 'Trails Near Me' },
            { url: 'user-details.html', title: 'User Profile' },
            { url: 'about.html', title: 'About' },
            { url: 'report.html', title: 'Report' },
            { url: 'documentation.html', title: 'API Documentation' },
            { url: 'settings.html', title: 'Settings' }
        ];

        async function searchPages(query) {
            const resultsContainer = document.getElementById('searchResults');

            if (!query || query.trim() === '') {
                resultsContainer.innerHTML = '<div class="alert alert-warning">Please enter a search term.</div>';
                return;
            }

            const queryLower = query.toLowerCase();
            const results = [];

            // Show loading state
            resultsContainer.innerHTML = `
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Searching pages...
                </div>
            `;

            // Fetch and search each page
            for (const page of pagesToSearch) {
                try {
                    const response = await fetch(page.url);
                    const html = await response.text();
                    
                    // Create a temporary DOM to parse the HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Find all text nodes in the main content
                    const mainContent = doc.querySelector('main') || doc.body;
                    
                    // Remove script, style, nav, and header tags
                    mainContent.querySelectorAll('script, style, nav, header').forEach(el => el.remove());
                    
                    // Find the first element containing the query text
                    const walker = document.createTreeWalker(mainContent, NodeFilter.SHOW_TEXT);
                    let matchingElement = null;
                    let textNode;
                    
                    while (textNode = walker.nextNode()) {
                        if (textNode.textContent.toLowerCase().includes(queryLower)) {
                            matchingElement = textNode.parentElement;
                            break;
                        }
                    }
                    
                    // Check if query matches
                    if (matchingElement) {
                        // Generate a unique ID for the matching element
                        const elementId = matchingElement.id || `search-match-${Math.random().toString(36).substr(2, 9)}`;
                        
                        // Get text content for snippet
                        const textContent = mainContent.textContent || '';
                        const index = textContent.toLowerCase().indexOf(queryLower);
                        const start = Math.max(0, index - 100);
                        const end = Math.min(textContent.length, index + query.length + 100);
                        let snippet = textContent.substring(start, end).trim();
                        
                        // Add ellipsis if needed
                        if (start > 0) snippet = '...' + snippet;
                        if (end < textContent.length) snippet = snippet + '...';
                        
                        // Highlight the query in snippet
                        const regex = new RegExp(`(${query})`, 'gi');
                        snippet = snippet.replace(regex, '<mark>$1</mark>');
                        
                        results.push({
                            title: page.title,
                            url: `${page.url}?highlight=${encodeURIComponent(query)}#search-highlight`,
                            snippet: snippet
                        });
                    }
                } catch (error) {
                    console.error(`Error searching ${page.url}:`, error);
                }
            }

            // Display results
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <h4 class="alert-heading">No Results Found</h4>
                        <p>No pages found matching "${query}". Try different keywords.</p>
                        <hr>
                        <a href="search.html" class="btn btn-success">Search Trails</a>
                        <a href="index.html" class="btn btn-outline-success">Back to Home</a>
                    </div>
                `;
                return;
            }

            const pageCount = results.length;
            let html = `<h2 class="mb-4">Found ${results.length} result${results.length !== 1 ? 's' : ''} across ${pageCount} page${pageCount !== 1 ? 's' : ''}</h2>`;
            
            results.forEach(result => {
                html += `
                    <article class="card mb-3">
                        <div class="card-body">
                            <h3 class="card-title h5">
                                <a href="${result.url}" class="text-decoration-none">${result.title}</a>
                            </h3>
                            <p class="card-text">${result.snippet}</p>
                        </div>
                    </article>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        // Perform search
        searchPages(searchQuery);
    </script>
</body>

</html>
